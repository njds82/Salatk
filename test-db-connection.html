<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ø®ØªØ¨Ø§Ø± Ø§ØªØµØ§Ù„ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª - Salatk</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .content {
            padding: 30px;
        }

        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 12px;
            border-left: 4px solid #667eea;
        }

        .test-section h2 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.5em;
        }

        .test-item {
            display: flex;
            align-items: center;
            padding: 12px;
            margin: 8px 0;
            background: white;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .test-item:hover {
            transform: translateX(-5px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .status-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            margin-left: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .status-pending {
            background: #ffc107;
            color: white;
        }

        .status-success {
            background: #28a745;
            color: white;
        }

        .status-error {
            background: #dc3545;
            color: white;
        }

        .test-name {
            flex: 1;
            font-weight: 500;
        }

        .test-result {
            font-size: 0.9em;
            color: #666;
            margin-right: 15px;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 1.1em;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            margin: 10px 5px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .actions {
            text-align: center;
            margin-top: 30px;
        }

        .summary {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-top: 20px;
            text-align: center;
        }

        .summary h3 {
            margin-bottom: 10px;
        }

        .summary-stats {
            display: flex;
            justify-content: space-around;
            margin-top: 15px;
        }

        .stat {
            text-align: center;
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .code-block {
            background: #2d2d2d;
            color: #f8f8f2;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            overflow-x: auto;
            direction: ltr;
            text-align: left;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #667eea;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ” Ø§Ø®ØªØ¨Ø§Ø± Ø§ØªØµØ§Ù„ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h1>
            <p>ÙØ­Øµ Ø´Ø§Ù…Ù„ Ù„Ø§ØªØµØ§Ù„ Supabase ÙˆÙ…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</p>
        </div>

        <div class="content">
            <!-- Connection Tests -->
            <div class="test-section">
                <h2>ğŸ”Œ Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„</h2>
                <div id="connection-tests"></div>
            </div>

            <!-- Data Sync Tests -->
            <div class="test-section">
                <h2>ğŸ”„ Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©</h2>
                <div id="sync-tests"></div>
            </div>

            <!-- Database Schema Tests -->
            <div class="test-section">
                <h2>ğŸ—„ï¸ Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h2>
                <div id="schema-tests"></div>
            </div>

            <!-- Summary -->
            <div id="summary" style="display: none;"></div>

            <!-- Actions -->
            <div class="actions">
                <button class="btn" onclick="runAllTests()">
                    <span id="test-btn-text">â–¶ï¸ Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø´Ø§Ù…Ù„</span>
                </button>
                <button class="btn btn-secondary" onclick="exportResults()">
                    ğŸ“Š ØªØµØ¯ÙŠØ± Ø§Ù„Ù†ØªØ§Ø¦Ø¬
                </button>
            </div>
        </div>
    </div>

    <!-- Dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/dexie@3.2.4/dist/dexie.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/db.js"></script>
    <script src="js/supabaseClient.js"></script>

    <script>
        const tests = {
            connection: [
                { id: 'supabase-loaded', name: 'ØªØ­Ù…ÙŠÙ„ Ù…ÙƒØªØ¨Ø© Supabase', test: testSupabaseLoaded },
                { id: 'client-init', name: 'ØªÙ‡ÙŠØ¦Ø© Ø¹Ù…ÙŠÙ„ Supabase', test: testClientInit },
                { id: 'auth-status', name: 'Ø­Ø§Ù„Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©', test: testAuthStatus },
                { id: 'indexeddb', name: 'IndexedDB Ù…ØªØ§Ø­', test: testIndexedDB }
            ],
            sync: [
                { id: 'sync-manager', name: 'SyncManager Ù…ØªØ§Ø­', test: testSyncManager },
                { id: 'prayer-service', name: 'PrayerService Ù…ØªØ§Ø­', test: testPrayerService },
                { id: 'habit-service', name: 'HabitService Ù…ØªØ§Ø­', test: testHabitService },
                { id: 'points-service', name: 'PointsService Ù…ØªØ§Ø­', test: testPointsService }
            ],
            schema: [
                { id: 'tables-exist', name: 'Ø¬Ø¯Ø§ÙˆÙ„ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', test: testTablesExist },
                { id: 'rls-enabled', name: 'Row Level Security', test: testRLSEnabled },
                { id: 'data-integrity', name: 'Ø³Ù„Ø§Ù…Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', test: testDataIntegrity }
            ]
        };

        let results = {};

        // Test Functions
        async function testSupabaseLoaded() {
            if (window.supabase) {
                return { success: true, message: 'Ù…ÙƒØªØ¨Ø© Supabase Ù…Ø­Ù…Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­' };
            }
            return { success: false, message: 'ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ù…ÙƒØªØ¨Ø© Supabase' };
        }

        async function testClientInit() {
            if (window.supabaseClient) {
                const url = window.supabaseClient.supabaseUrl;
                return { success: true, message: `Ù…ØªØµÙ„ Ø¨Ù€: ${url}` };
            }
            return { success: false, message: 'Ù„Ù… ÙŠØªÙ… ØªÙ‡ÙŠØ¦Ø© Ø¹Ù…ÙŠÙ„ Supabase' };
        }

        async function testAuthStatus() {
            try {
                const { data: { session } } = await window.supabaseClient.auth.getSession();
                if (session) {
                    return { success: true, message: `Ù…Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„: ${session.user.email}` };
                }
                return { success: false, message: 'ØºÙŠØ± Ù…Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„ - Ø¨Ø¹Ø¶ Ø§Ù„Ù…ÙŠØ²Ø§Øª Ù‚Ø¯ Ù„Ø§ ØªØ¹Ù…Ù„' };
            } catch (error) {
                return { success: false, message: `Ø®Ø·Ø£: ${error.message}` };
            }
        }

        async function testIndexedDB() {
            try {
                if (window.db && window.db.isOpen()) {
                    const tables = window.db.tables.map(t => t.name).join(', ');
                    return { success: true, message: `Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„: ${tables}` };
                }
                return { success: false, message: 'IndexedDB ØºÙŠØ± Ù…ØªØ§Ø­' };
            } catch (error) {
                return { success: false, message: `Ø®Ø·Ø£: ${error.message}` };
            }
        }

        async function testSyncManager() {
            if (window.SyncManager) {
                const methods = ['pullAllData', 'pushAllLocalData', 'pushPrayerRecord', 'pushHabit'];
                const available = methods.filter(m => typeof window.SyncManager[m] === 'function');
                return { success: true, message: `${available.length}/${methods.length} Ø¯Ø§Ù„Ø© Ù…ØªØ§Ø­Ø©` };
            }
            return { success: false, message: 'SyncManager ØºÙŠØ± Ù…ØªØ§Ø­' };
        }

        async function testPrayerService() {
            if (window.PrayerService) {
                const methods = ['getDailyPrayers', 'markPrayer', 'resetPrayer'];
                const available = methods.filter(m => typeof window.PrayerService[m] === 'function');
                return { success: true, message: `${available.length}/${methods.length} Ø¯Ø§Ù„Ø© Ù…ØªØ§Ø­Ø©` };
            }
            return { success: false, message: 'PrayerService ØºÙŠØ± Ù…ØªØ§Ø­' };
        }

        async function testHabitService() {
            if (window.HabitService) {
                const methods = ['getAll', 'add', 'logAction', 'delete'];
                const available = methods.filter(m => typeof window.HabitService[m] === 'function');
                return { success: true, message: `${available.length}/${methods.length} Ø¯Ø§Ù„Ø© Ù…ØªØ§Ø­Ø©` };
            }
            return { success: false, message: 'HabitService ØºÙŠØ± Ù…ØªØ§Ø­' };
        }

        async function testPointsService() {
            if (window.PointsService) {
                const methods = ['addPoints', 'getTotal', 'getHistory'];
                const available = methods.filter(m => typeof window.PointsService[m] === 'function');
                return { success: true, message: `${available.length}/${methods.length} Ø¯Ø§Ù„Ø© Ù…ØªØ§Ø­Ø©` };
            }
            return { success: false, message: 'PointsService ØºÙŠØ± Ù…ØªØ§Ø­' };
        }

        async function testTablesExist() {
            try {
                const { data: { session } } = await window.supabaseClient.auth.getSession();
                if (!session) {
                    return { success: false, message: 'ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„' };
                }

                const tables = ['user_settings', 'prayer_records', 'habits', 'points_history', 'qada_prayers'];
                const checks = await Promise.all(
                    tables.map(async table => {
                        const { error } = await window.supabaseClient.from(table).select('*').limit(1);
                        return !error;
                    })
                );

                const available = checks.filter(c => c).length;
                return { 
                    success: available === tables.length, 
                    message: `${available}/${tables.length} Ø¬Ø¯ÙˆÙ„ Ù…ØªØ§Ø­` 
                };
            } catch (error) {
                return { success: false, message: `Ø®Ø·Ø£: ${error.message}` };
            }
        }

        async function testRLSEnabled() {
            try {
                const { data: { session } } = await window.supabaseClient.auth.getSession();
                if (!session) {
                    return { success: false, message: 'ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ø§Ø®ØªØ¨Ø§Ø± RLS' };
                }

                // Try to access data - RLS should allow only user's data
                const { data, error } = await window.supabaseClient
                    .from('user_settings')
                    .select('*')
                    .eq('user_id', session.user.id);

                if (!error) {
                    return { success: true, message: 'RLS Ù…ÙØ¹Ù„ ÙˆÙŠØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­' };
                }
                return { success: false, message: `Ø®Ø·Ø£ RLS: ${error.message}` };
            } catch (error) {
                return { success: false, message: `Ø®Ø·Ø£: ${error.message}` };
            }
        }

        async function testDataIntegrity() {
            try {
                // Check local data count
                const localPrayers = await db.prayers.count();
                const localHabits = await db.habits.count();
                const localPoints = await db.points.count();

                return { 
                    success: true, 
                    message: `Ù…Ø­Ù„ÙŠ: ${localPrayers} ØµÙ„Ø§Ø©ØŒ ${localHabits} Ø¹Ø§Ø¯Ø©ØŒ ${localPoints} Ù†Ù‚Ø·Ø©` 
                };
            } catch (error) {
                return { success: false, message: `Ø®Ø·Ø£: ${error.message}` };
            }
        }

        // UI Functions
        function createTestItem(test, result) {
            const statusClass = result ? (result.success ? 'status-success' : 'status-error') : 'status-pending';
            const statusIcon = result ? (result.success ? 'âœ“' : 'âœ—') : 'â³';
            const resultText = result ? result.message : 'ÙÙŠ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±...';

            return `
                <div class="test-item" id="test-${test.id}">
                    <div class="status-icon ${statusClass}">${statusIcon}</div>
                    <div class="test-name">${test.name}</div>
                    <div class="test-result">${resultText}</div>
                </div>
            `;
        }

        function renderTests() {
            document.getElementById('connection-tests').innerHTML = 
                tests.connection.map(t => createTestItem(t, results[t.id])).join('');
            
            document.getElementById('sync-tests').innerHTML = 
                tests.sync.map(t => createTestItem(t, results[t.id])).join('');
            
            document.getElementById('schema-tests').innerHTML = 
                tests.schema.map(t => createTestItem(t, results[t.id])).join('');
        }

        async function runAllTests() {
            const btn = document.getElementById('test-btn-text');
            btn.innerHTML = '<span class="loading"></span> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±...';
            document.querySelector('.btn').disabled = true;

            results = {};
            renderTests();

            // Run all tests sequentially
            const allTests = [...tests.connection, ...tests.sync, ...tests.schema];
            
            for (const test of allTests) {
                try {
                    results[test.id] = await test.test();
                } catch (error) {
                    results[test.id] = { success: false, message: `Ø®Ø·Ø£: ${error.message}` };
                }
                renderTests();
                await new Promise(resolve => setTimeout(resolve, 300)); // Small delay for visual effect
            }

            showSummary();
            btn.innerHTML = 'âœ“ Ø§ÙƒØªÙ…Ù„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±';
            document.querySelector('.btn').disabled = false;
        }

        function showSummary() {
            const total = Object.keys(results).length;
            const passed = Object.values(results).filter(r => r.success).length;
            const failed = total - passed;
            const percentage = Math.round((passed / total) * 100);

            const summaryHTML = `
                <div class="summary">
                    <h3>ğŸ“Š Ù…Ù„Ø®Øµ Ø§Ù„Ù†ØªØ§Ø¦Ø¬</h3>
                    <div class="summary-stats">
                        <div class="stat">
                            <div class="stat-number">${total}</div>
                            <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª</div>
                        </div>
                        <div class="stat">
                            <div class="stat-number">${passed}</div>
                            <div class="stat-label">Ù†Ø¬Ø­</div>
                        </div>
                        <div class="stat">
                            <div class="stat-number">${failed}</div>
                            <div class="stat-label">ÙØ´Ù„</div>
                        </div>
                        <div class="stat">
                            <div class="stat-number">${percentage}%</div>
                            <div class="stat-label">Ù†Ø³Ø¨Ø© Ø§Ù„Ù†Ø¬Ø§Ø­</div>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('summary').innerHTML = summaryHTML;
            document.getElementById('summary').style.display = 'block';
        }

        function exportResults() {
            const report = {
                timestamp: new Date().toISOString(),
                results: results,
                summary: {
                    total: Object.keys(results).length,
                    passed: Object.values(results).filter(r => r.success).length,
                    failed: Object.values(results).filter(r => !r.success).length
                }
            };

            const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `salatk-db-test-${Date.now()}.json`;
            a.click();
        }

        // Initialize
        renderTests();
    </script>
</body>
</html>
